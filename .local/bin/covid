#!/bin/python
import sys
import requests
import json
from pathlib import Path

if len(sys.argv) == 1:
    country = 'FR' # DEFAULT
else:
    country = sys.argv[1].upper()
f_log = Path(f'~/Notes/covid_{country}.json').expanduser()
if f_log.exists():
    f_log = f_log.expanduser().as_posix()

res = requests.get(f'https://covid19-api.org/api/status/{country}')
if not res.ok:
    sys.exit(1)
data = res.json()

with open(f_log, 'r') as f:
    old_data = json.load(f)
if old_data['last_update'] == data['last_update']:
    d_cases = old_data['diff_cases']
    d_new = old_data['diff_new_cases']
    print(f"ã€½{old_data['cases']:,}{d_cases} [+{old_data['new_cases']:,}{d_new}]")
    sys.exit(0)
else:
    diff = requests.get(f'https://covid19-api.org/api/diff/{country}').json()
    data.update(diff)
    cases = data['cases']
    d_cases = "ðŸ”º" if data['cases'] > old_data['cases'] else "ðŸ”½"
    d_new = "ðŸ”º" if data['new_cases'] > old_data['new_cases'] else "ðŸ”½"
    print(f"ã€½{data['cases']:,}{d_cases} [+{data['new_cases']:,}{d_new}]")
    data['diff_cases'] = d_cases
    data['diff_new_cases'] = d_new
    # Updating file
    with open(f_log, 'w') as f:
        json.dump(data, f)
        sys.exit(0)
