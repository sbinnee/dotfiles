#!/bin/sh
drives=$(lsblk -nrpo "name,type,size,mountpoint" | awk '$4!~/\/boot|\/home$|SWAP|^\/mnt\/storage/&&length($4)>1{printf "%s (%s)\n",$4,$3}')
remotedrives=$(rclone listremotes | tr -d ':')
# echo $drives
remotes=$(df -h | grep ':' | awk '{printf "%s (%s) [rclone]\n",$6,$2}')

# Check if any
[ -z "$drives$remotes" ] && notify-send "ðŸ’» No drives to unmount" && exit
chosen="$(echo -e "$drives\n$remotes" | dmenu -l 10 -i -p "Unmount which drive?")" || exit 1
chosen="$(echo "$chosen" | awk '{print $1}')"

if [[ "$remotedrives" = *"${chosen##*/}"* ]]
then
	echo "Remote selected"
	fusermount -u "$chosen" && \
		notify-send -i "$HOME/.config/dunst/rclone_logo.png" -t 10000 "Unmounting remote" "$chosen" || \
		notify-send -i "$HOME/.config/dunst/rclone_logo.png" -u ciritical -t 5000 "Failed unmounting"
else
	echo "Local selected"
	sudo -A umount "$chosen" && \
		notify-send "ðŸ’» USB unmounting" "$chosen unmounted." || \
		notify-send -u ciritical -t 5000 "ðŸ’» Failed USB unmounting" "$chosen"
fi

[ -z "$drives" ] && echo "No drives to unmount." &&  exit

