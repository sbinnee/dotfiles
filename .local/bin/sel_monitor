#!/bin/sh

# Default built-in mode
INTERNAL_MODE=1920x1080

query=$(xrandr -q)
l=$(echo "$query" | egrep "\sconnected" | cut -d' ' -f1)
count=$(echo $l | wc -w)

if [ $count -eq 1 ]; then
    # echo "only internal connected"
    xrandr --auto && \
    notify-send -t 3000 "ðŸ–¥ Recover internal screen" && \
    bspc wm -r
elif [ $count -eq 2 ]; then
    first=$(echo $l | cut -d' ' -f1)
    second=$(echo $l | cut -d' ' -f2)
    nFirst=2
    nSecond=$(echo "$query" | grep -nP "^$second" | cut -d: -f1)
    nEnd=$(echo "$query" | grep -m 1 -nP "\sdisconnected" | cut -d: -f1)
    lenFirst=$(( nSecond - nFirst -1 ))
    lenSecond=$(( nEnd - nSecond -1 ))

    # modeFirst=$(echo "$query" | grep -A $lenFirst "^$first" | awk 'NR>1 {print $1}')
    modeSecond=$(echo "$query" | grep -A $lenSecond "^$second" | awk 'NR>1 {print $1}')

    arg="Mirror\nRight\nLeft\nAbove\nBelow\nPrimary\nSecondary"
    option=$(echo $arg | dmenu -i)
    if [ -z "$option" ]
    then
        exit 1
    fi
    mode=$(echo "$modeSecond" | dmenu -i -l $lenSecond)
    if [ -z "$mode" ]
    then
        exit 1
    fi
    case $option in
        "Mirror")
            xrandr --output $second --mode "$mode" --scale-from $INTERNAL_MODE --output $first --auto && \
            notify-send -t 5000 "ðŸ–¥ Mirroring screens"
            ;;
        "Right")
            xrandr --output $first --primary --output $second --mode "$mode" --right-of $first && \
            notify-send -t 5000 "ðŸ–¥ Secondary screen on right side"
            ;;
        "Left")
            xrandr --output $first --primary --output $second --mode "$mode" --left-of $first && \
            notify-send -t 5000 "ðŸ–¥ Secondary screen on left side"
            ;;
        "Above")
            xrandr --output $first --primary --output $second --mode "$mode" --above $first && \
            notify-send -t 5000 "ðŸ–¥ Secondary screen above "
            ;;
        "Below")
            xrandr --output $first --primary --output $second --mode "$mode" --below $first && \
            notify-send -t 5000 "ðŸ–¥ Secondary screen below"
            ;;
        "Primary")
            xrandr --output $first --primary --auto --output $second --off && \
            notify-send -t 5000 "ðŸ–¥ Screen on internal screen"
            ;;
        "Secondary")
            xrandr --output $second --primary --mode "$mode" --output $first --off && \
            notify-send -t 5000 "ðŸ–¥ Screen on second screen"
            ;;
        *)
            ;;
    esac
    bspc wm -r
else
    # More than 3 display available....
    echo "#Display >= 3, Not implemented"
    exit 1
fi
